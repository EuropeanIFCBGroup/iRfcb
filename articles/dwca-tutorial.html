<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating a DwC-A from IFCB Data • iRfcb</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating a DwC-A from IFCB Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">iRfcb</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/a-general-tutorial.html">iRfcb Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/qc-tutorial.html">Quality Control of IFCB Data</a></li>
    <li><a class="dropdown-item" href="../articles/matlab-tutorial.html">Handling MATLAB Results</a></li>
    <li><a class="dropdown-item" href="../articles/dwca-tutorial.html">Creating a DwC-A from IFCB Data</a></li>
    <li><a class="dropdown-item" href="../articles/image-export-tutorial.html">Sharing Annotated IFCB Images</a></li>
    <li><a class="dropdown-item" href="../articles/ecotaxa-tutorial.html">Prepare IFCB Images for EcoTaxa</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/EuropeanIFCBGroup/iRfcb/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Creating a DwC-A from IFCB Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EuropeanIFCBGroup/iRfcb/blob/main/vignettes/dwca-tutorial.Rmd" class="external-link"><code>vignettes/dwca-tutorial.Rmd</code></a></small>
      <div class="d-none name"><code>dwca-tutorial.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial demonstrates how to create a Darwin Core Archive
(DwC-A) from Imaging FlowCytobot (IFCB) results processed using MATLAB
code from the <a href="https://github.com/hsosik/ifcb-analysis" class="external-link">ifcb-analysis</a>
repository (Sosik and Olson 2007). However, the code can be adapted to
process classifications from other machine learning algorithms as well.
The example below is based on a subset of manually annotated image data
from the <a href="https://doi.org/10.17044/scilifelab.25883455.v3" class="external-link">SMHI
IFCB Plankton Image Reference Library (version 3)</a> (Torstensson et
al. 2024), and aligns with the <em>best practices</em> outlined by
Martin-Cabrera et al. (2022).</p>
<p>The DwC-A is a widely accepted standard for sharing biodiversity
data. It organizes data into structured tables, such as sampling events,
occurrences, and measurement or facts (MoF), which can be linked through
unique identifiers. This standardized format facilitates data sharing,
integration, and reuse across platforms, enabling interoperability with
global biodiversity databases like the Global Biodiversity Information
Facility (<a href="https://www.gbif.org/" class="external-link">GBIF</a>), Ocean Biodiversity
Information System (<a href="https://obis.org/" class="external-link">OBIS</a>) and the
European Marine Observation and Data Network Biology (<a href="https://emodnet.ec.europa.eu/en/biology" class="external-link">EMODNet Biology</a>).</p>
<p>By using the <code>iRfcb</code> package in combination with the <a href="https://livingnorway.github.io/LivingNorwayR/" class="external-link"><code>LivingNorwayR</code></a>
package, this tutorial guides you through creating a sampling
event-based DwC-A. The archive includes occurrence and MoF tables,
ensuring the IFCB results meet the requirements of major biodiversity
repositories.</p>
<p>With DwC-A, your data can become part of a global ecosystem of
interoperable datasets, contributing to biodiversity research and
monitoring on an international scale. Standardized datasets like these
enable diverse applications, such as the development of digital
twins—virtual models of ecosystems used to simulate and predict
environmental changes. This tutorial provides a reproducible workflow to
help you prepare your IFCB data for submission to these large databases
while adhering to international data standards, broadening its potential
for innovative uses in biodiversity science.</p>
</div>
<div class="section level2">
<h2 id="getting-started">Getting Started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<div class="section level3">
<h3 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h3>
<p>You can install the <code>iRfcb</code> and <code>LivingNorwayR</code>
packages from GitHub using the <code>remotes</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"EuropeanIFCBGroup/iRfcb"</span>,</span>
<span>                           <span class="st">"LivingNorway/LivingNorwayR"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Load the required libraries:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://europeanifcbgroup.github.io/iRfcb/">iRfcb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/LivingNorway/LivingNorwayR" class="external-link">LivingNorwayR</a></span><span class="op">)</span> <span class="co"># For DwC-A creation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="co"># For data wrangling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span> <span class="co"># For data wrangling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rforge.net/uuid" class="external-link">uuid</a></span><span class="op">)</span> <span class="co"># For generating unique identifiers</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="download-sample-data">Download Sample Data<a class="anchor" aria-label="anchor" href="#download-sample-data"></a>
</h3>
<p>To get started, download sample data from the <a href="https://doi.org/10.17044/scilifelab.25883455.v3" class="external-link">SMHI IFCB
Plankton Image Reference Library</a> (Torstensson et al. 2024) with the
following function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define data directory</span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="st">"data"</span></span>
<span></span>
<span><span class="co"># Download and extract test data in the data folder</span></span>
<span><span class="fu"><a href="../reference/ifcb_download_test_data.html">ifcb_download_test_data</a></span><span class="op">(</span>dest_dir <span class="op">=</span> <span class="va">data_dir</span>,</span>
<span>                        max_retries <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                        sleep_time <span class="op">=</span> <span class="fl">30</span>,</span>
<span>                        verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="extract-data">Extract Data<a class="anchor" aria-label="anchor" href="#extract-data"></a>
</h2>
<div class="section level3">
<h3 id="extract-positions-and-timestamps">Extract Positions and Timestamps<a class="anchor" aria-label="anchor" href="#extract-positions-and-timestamps"></a>
</h3>
<p>In this example, most of the coordinates are stored within the
<code>.hdr</code> files and are extracted along with the corresponding
timestamps in the following step:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read HDR data and extract GPS position (when available) and timestamps</span></span>
<span><span class="va">gps_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ifcb_read_hdr_data.html">ifcb_read_hdr_data</a></span><span class="op">(</span><span class="st">"data/data/"</span>,</span>
<span>                               gps_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                               verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="summarize-counts-biovolumes-and-carbon-content-from-manually-annotated-ifcb-data">Summarize Counts, Biovolumes and Carbon Content from Manually
Annotated IFCB Data<a class="anchor" aria-label="anchor" href="#summarize-counts-biovolumes-and-carbon-content-from-manually-annotated-ifcb-data"></a>
</h3>
<p>You can also apply this process to automatically classified data by
setting the <code>mat_folder</code> parameter to point to your
<code>class</code> folder, and setting <code>class2use_file</code> to
<code>NULL</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summarize biovolume data using IFCB data from manual data folder</span></span>
<span><span class="va">manual_biovolume_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ifcb_summarize_biovolumes.html">ifcb_summarize_biovolumes</a></span><span class="op">(</span>feature_folder <span class="op">=</span> <span class="st">"data/features"</span>,</span>
<span>                                                   mat_folder <span class="op">=</span> <span class="st">"data/manual"</span>,</span>
<span>                                                   class2use_file <span class="op">=</span> <span class="st">"data/config/class2use.mat"</span>,</span>
<span>                                                   hdr_folder <span class="op">=</span> <span class="st">"data/data"</span>,</span>
<span>                                                   verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The coordinates and biovolume data are now combined into a single
unified dataframe.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summarize manually annotated biovolume data</span></span>
<span><span class="va">data_manual</span> <span class="op">&lt;-</span> <span class="va">gps_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">manual_biovolume_data</span>, by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="event-core">Event Core<a class="anchor" aria-label="anchor" href="#event-core"></a>
</h2>
<div class="section level3">
<h3 id="parent-events">Parent Events<a class="anchor" aria-label="anchor" href="#parent-events"></a>
</h3>
<p>Each event can belong to a higher-level event, referred to as a
Parent Event. In this example, the Parent Event is the dataset itself,
and the main events are the samples. However, in more extensive
datasets, Parent Events could represent broader categories, such as
cruises, instrument numbers, specific years, or other hierarchical
groupings. Later we can add MoF data to each event level.</p>
<p>Each Parent Event must have a unique, persistent identifier, referred
to as <strong>parentEventID</strong>. We generate these identifiers
using the <code>uuid</code> package (Urbanek and Ts’o 2021), ensuring
they are both globally unique and consistent.</p>
<p>Additionally, each Parent Event is associated with specific date
ranges, which must be captured as <strong>eventDate</strong> to reflect
the temporal span of the observations or data collection. This helps
provide clear temporal context for the data. Other project-specific
terms can be defined here as well, such as
<strong>datasetName</strong>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add a single parentEventID for all samples in the dataset</span></span>
<span><span class="va">data_event</span> <span class="op">&lt;-</span> <span class="va">data_manual</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>parentEventID <span class="op">=</span> <span class="fu">uuid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uuid/man/UUIDgenerate.html" class="external-link">UUIDgenerate</a></span><span class="op">(</span>use.time <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Event Date and info for parentEvents</span></span>
<span><span class="va">data_parent_event</span> <span class="op">&lt;-</span> <span class="va">data_event</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">parentEventID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, max<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>            ifcb_number <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ifcb_number</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>eventID <span class="op">=</span> <span class="va">parentEventID</span>,</span>
<span>         parentEventID <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>         eventType <span class="op">=</span> <span class="st">"Project"</span>,</span>
<span>         datasetName <span class="op">=</span> <span class="st">"iRfcb-DwC-A"</span>,</span>
<span>         eventDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">min</span>, <span class="st">"/"</span>, <span class="va">max</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">min</span>, <span class="op">-</span><span class="va">max</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sample-events">Sample Events<a class="anchor" aria-label="anchor" href="#sample-events"></a>
</h3>
<p>To organize our data effectively, we start by defining key event
terms. These include general terms like <strong>eventType</strong> and
<strong>ownerInstitutionCode</strong>. <strong>institutionID</strong>
for many European institutions can be retrieved from various registries,
such as the <a href="https://edmo.seadatanet.org/" class="external-link">European Directory of
Marine Organisations (EDMO)</a>. Each term represents specific metadata
associated with the collected data. Below is the annotated R code that
processes and structures the data into an event-focused format.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add metadata columns to the data</span></span>
<span><span class="va">data_event</span> <span class="op">&lt;-</span> <span class="va">data_event</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Defining the institution who own and are responsible for the data</span></span>
<span>    ownerInstitutionCode <span class="op">=</span> <span class="st">"SMHI"</span>,</span>
<span>    institutionID <span class="op">=</span> <span class="st">"https://edmo.seadatanet.org/report/545"</span>,</span>
<span>    institutionCode <span class="op">=</span> <span class="st">"SMHI"</span>,</span>
<span>    </span>
<span>    <span class="co"># Defining CC-BY data licence</span></span>
<span>    license <span class="op">=</span> <span class="st">"http://creativecommons.org/licenses/by/4.0/legalcodeY"</span>,</span>
<span>    </span>
<span>    <span class="co"># Specifying the type of record, which is Sample in this case</span></span>
<span>    eventType <span class="op">=</span> <span class="st">"Sample"</span>,</span>
<span>    </span>
<span>    <span class="co"># Mapping existing date and time fields to standard terms</span></span>
<span>    eventDate <span class="op">=</span> <span class="va">date</span>,</span>
<span>    eventTime <span class="op">=</span> <span class="va">time</span>,</span>
<span>    </span>
<span>    <span class="co"># Adding geographical information</span></span>
<span>    decimalLatitude <span class="op">=</span> <span class="va">gpsLatitude</span>,</span>
<span>    decimalLongitude <span class="op">=</span> <span class="va">gpsLongitude</span>,</span>
<span>    locality <span class="op">=</span> <span class="cn">NA</span>, <span class="co"># The specific description of the place, if available</span></span>
<span>    verbatimLocality <span class="op">=</span> <span class="cn">NA</span>, <span class="co"># The original textual description of the place</span></span>
<span>    geodeticDatum <span class="op">=</span> <span class="st">"EPSG:4326"</span>,</span>
<span>    countryCode <span class="op">=</span> <span class="st">"SE"</span>,</span>
<span>    country <span class="op">=</span> <span class="st">"Sweden"</span>,</span>
<span>    </span>
<span>    <span class="co"># Specifying the size and unit of the sample analyzed</span></span>
<span>    sampleSizeValue <span class="op">=</span> <span class="va">ml_analyzed</span>,</span>
<span>    sampleSizeUnit <span class="op">=</span> <span class="st">"Millilitres"</span>,</span>
<span>    </span>
<span>    <span class="co"># Indicating the depth at which samples were taken</span></span>
<span>    minimumDepthInMeters <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    maximumDepthInMeters <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    </span>
<span>    <span class="co"># Describing the sampling protocol</span></span>
<span>    samplingProtocol <span class="op">=</span> <span class="st">"Imaging FlowCytobot integrated into the Ferrybox system aboard the R/V Svea, continuously capturing plankton images from a depth of 4 meters"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Grouping by sample to assign unique event IDs</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>eventID <span class="op">=</span> <span class="fu">uuid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uuid/man/UUIDgenerate.html" class="external-link">UUIDgenerate</a></span><span class="op">(</span>use.time <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>If the exact sample position is unknown, the coordinates can be
estimated and paired with a
<strong>coordinateUncertaintyInMeters</strong> value. In this case, the
samples originate from the Swedish west coast, and we assign coordinates
within the Skagerrak and Kattegat region and specify an uncertainty of
150 km, which encompasses most of these areas.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add estimated coordinates and uncertainty for events with missing positions</span></span>
<span><span class="va">data_event</span> <span class="op">&lt;-</span> <span class="va">data_event</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    coordinateUncertaintyInMeters <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">decimalLongitude</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">decimalLatitude</span><span class="op">)</span>, </span>
<span>                                            <span class="fl">150000</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    decimalLongitude <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">decimalLongitude</span><span class="op">)</span>, </span>
<span>                               <span class="fl">11.3</span>, <span class="va">decimalLongitude</span><span class="op">)</span>,</span>
<span>    decimalLatitude <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">decimalLatitude</span><span class="op">)</span>, </span>
<span>                              <span class="fl">57.4</span>, <span class="va">decimalLatitude</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>Next, we extract the relevant columns for the Event tables and
combine the Event and Parent Event tables into a single data frame.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a clean data frame with selected columns</span></span>
<span><span class="va">event_df</span> <span class="op">&lt;-</span> <span class="va">data_event</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">eventType</span>, <span class="va">ownerInstitutionCode</span>, <span class="va">institutionCode</span>, <span class="va">institutionID</span>,  </span>
<span>         <span class="va">parentEventID</span>, <span class="va">eventID</span>, <span class="va">license</span>, <span class="va">samplingProtocol</span>, <span class="va">sampleSizeValue</span>, </span>
<span>         <span class="va">sampleSizeUnit</span>, <span class="va">eventDate</span>, <span class="va">eventTime</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">country</span>, </span>
<span>         <span class="va">countryCode</span>, <span class="va">decimalLatitude</span>, <span class="va">decimalLongitude</span>, <span class="va">geodeticDatum</span>, </span>
<span>         <span class="va">coordinateUncertaintyInMeters</span>, <span class="va">locality</span>, <span class="va">verbatimLocality</span>, </span>
<span>         <span class="va">minimumDepthInMeters</span>, <span class="va">maximumDepthInMeters</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>eventDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">eventDate</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># Ensure rows are unique</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a clean data frame with selected columns</span></span>
<span><span class="va">parent_event_df</span> <span class="op">&lt;-</span> <span class="va">data_parent_event</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ifcb_number</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Adjust eventDate to character format and append additional parent event data</span></span>
<span><span class="va">event_df</span> <span class="op">&lt;-</span> <span class="va">parent_event_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>eventDate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">eventDate</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">event_df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the final table as tibble</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">event_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 26</span></span></span>
<span><span class="co">##    parentEventID    eventID eventType datasetName eventDate ownerInstitutionCode</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> <span style="color: #BB0000;">NA</span>               282da5… Project   iRfcb-DwC-A 2022-05-… <span style="color: #BB0000;">NA</span>                  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 282da5ef-a2d2-4… 6196dc… Sample    <span style="color: #BB0000;">NA</span>          2022-05-… SMHI                </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 282da5ef-a2d2-4… d467c8… Sample    <span style="color: #BB0000;">NA</span>          2022-05-… SMHI                </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 282da5ef-a2d2-4… 2847e1… Sample    <span style="color: #BB0000;">NA</span>          2022-07-… SMHI                </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> 282da5ef-a2d2-4… c7aabe… Sample    <span style="color: #BB0000;">NA</span>          2022-07-… SMHI                </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 282da5ef-a2d2-4… 412324… Sample    <span style="color: #BB0000;">NA</span>          2023-03-… SMHI                </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> 282da5ef-a2d2-4… 86ec73… Sample    <span style="color: #BB0000;">NA</span>          2023-03-… SMHI                </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 282da5ef-a2d2-4… 09e32e… Sample    <span style="color: #BB0000;">NA</span>          2023-08-… SMHI                </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 282da5ef-a2d2-4… 8ddaa3… Sample    <span style="color: #BB0000;">NA</span>          2023-09-… SMHI                </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 282da5ef-a2d2-4… 52a247… Sample    <span style="color: #BB0000;">NA</span>          2023-09-… SMHI                </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 20 more variables: institutionCode &lt;chr&gt;, institutionID &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   license &lt;chr&gt;, samplingProtocol &lt;chr&gt;, sampleSizeValue &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   sampleSizeUnit &lt;chr&gt;, eventTime &lt;time&gt;, year &lt;dbl&gt;, month &lt;dbl&gt;, day &lt;int&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   country &lt;chr&gt;, countryCode &lt;chr&gt;, decimalLatitude &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   decimalLongitude &lt;dbl&gt;, geodeticDatum &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   coordinateUncertaintyInMeters &lt;dbl&gt;, locality &lt;lgl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   verbatimLocality &lt;lgl&gt;, minimumDepthInMeters &lt;dbl&gt;, …</span></span></span></code></pre>
<p>The final stage is to initialise an event object in the
<code>livingNorwayR</code> package - this will be used later to build
the DwC compliant data package.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GBIF_Event</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://livingnorway.github.io/LivingNorwayR/reference/initializeGBIFEvent.html" class="external-link">initializeGBIFEvent</a></span><span class="op">(</span><span class="va">event_df</span>, </span>
<span>                                  idColumnInfo <span class="op">=</span> <span class="st">"eventID"</span>, </span>
<span>                                  nameAutoMap <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="occurrence-extension">Occurrence Extension<a class="anchor" aria-label="anchor" href="#occurrence-extension"></a>
</h2>
<p>The Occurrence table captures information about individual organisms
or observations, linking them to a specific event. For IFCB data, the
<strong>basisOfRecord</strong> indicates how the observation was made.
IFCB data are defined as <em>MachineObservation</em>, and since this
example uses manually annotated images, the
<strong>identificationVerificationStatus</strong> is set to
<em>ValidatedByHuman</em>. For best practices in plankton imaging data
management, see <a href="https://dx.doi.org/10.25607/OBP-1742" class="external-link">Martin-Cabrera et
al. (2022)</a>.</p>
<div class="section level3">
<h3 id="annotated-code-define-occurrence-data">Annotated Code: Define Occurrence Data<a class="anchor" aria-label="anchor" href="#annotated-code-define-occurrence-data"></a>
</h3>
<p>Each class observation is considered an occurrence in the IFCB data.
The following code transforms the data into an occurrence table, adding
essential fields such as <strong>type</strong>,
<strong>collectionCode</strong>, <strong>occurrenceID</strong>,
<strong>basisOfRecord</strong>,
<strong>identificationVerificationStatus</strong>,
<strong>identificationReferences</strong>,
<strong>identifiedBy</strong>, and <strong>associatedMedia</strong>.
These fields provide context and provenance information for each
occurrence.</p>
<p>Links to raw images can be included in
<strong>associatedMedia</strong>. These links may point to resources
such as the IFCB Dashboard, Ecotaxa, or other image archives. Learn how
to prepare images for Ecotaxa using <code>iRfcb</code> in this <a href="../articles/ecotaxa-tutorial.html">tutorial</a>, or how to export
images to an <a href="../articles/image-export-tutorial.html">image
repository</a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create an occurrence table by transforming event data and adding fields</span></span>
<span><span class="va">data_occurrences</span> <span class="op">&lt;-</span> <span class="va">data_event</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>  </span>
<span>    type <span class="op">=</span> <span class="st">"StillImage"</span>,  <span class="co"># Specifies the record type as an image  </span></span>
<span>    collectionCode <span class="op">=</span> <span class="st">"iRfcb"</span>,  <span class="co"># Provides a collection identifier  </span></span>
<span>    occurrenceID <span class="op">=</span> <span class="fu">uuid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uuid/man/UUIDgenerate.html" class="external-link">UUIDgenerate</a></span><span class="op">(</span>use.time <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,  <span class="co"># Generates a unique identifier for each occurrence  </span></span>
<span>    basisOfRecord <span class="op">=</span> <span class="st">"MachineObservation"</span>, <span class="co"># Indicates the data was recorded by a machine  </span></span>
<span>    identificationVerificationStatus <span class="op">=</span> <span class="st">"ValidatedByHuman"</span>, <span class="co"># Indicate that the images have been validated</span></span>
<span>    identificationReferences <span class="op">=</span> <span class="st">"https://github.com/hsosik/ifcb-analysis/wiki/Instructions-for-manual-annotation-of-images"</span>,</span>
<span>    identifiedBy <span class="op">=</span> <span class="st">"John Doe"</span>, <span class="co"># Indicate who validated the image</span></span>
<span>    associatedMedia <span class="op">=</span> <span class="st">"https://ecotaxa.obs-vlfr.fr/prj/14392"</span> <span class="co"># Link to images (if available)</span></span>
<span>  <span class="op">)</span>  </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="taxonomic-data-cleaning-and-retrieval">Taxonomic Data Cleaning and Retrieval<a class="anchor" aria-label="anchor" href="#taxonomic-data-cleaning-and-retrieval"></a>
</h3>
<p>Class names often include excess or inconsistent information, such as
underscores or morphological descriptors, which can complicate the
assignment of proper taxonomical names needed for the occurrence table.
These names need to be cleaned before mapping them to higher taxonomic
levels using external sources like <a href="https://www.marinespecies.org/" class="external-link">WoRMS</a>, as demonstrated
below.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get taxa names</span></span>
<span><span class="va">taxa_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">data_occurrences</span><span class="op">$</span><span class="va">class</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Clean taxa_names by substituting specific patterns with spaces or empty strings</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"_"</span>, <span class="st">" "</span>, <span class="va">taxa_names</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" single cell"</span>, <span class="st">""</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" chain"</span>, <span class="st">""</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" group"</span>, <span class="st">""</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"-like"</span>, <span class="st">""</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" larger than 30unidentified"</span>, <span class="st">""</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" smaller than 30unidentified"</span>, <span class="st">""</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove species flags from class names</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\&lt;spp\\&gt;"</span>, <span class="st">""</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"  "</span>, <span class="st">" "</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Turn f to f. for forma</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\bf\\b"</span>, <span class="st">"f."</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add "/" for multiple names with capital letters</span></span>
<span><span class="co"># e.g. Heterocapsa_Azadinium to Heterocapsa/Azadinium</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" ([A-Z])"</span>, <span class="st">"/\\1"</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" ([A-Z])"</span>, <span class="st">"/\\1"</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove any whitespace</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html" class="external-link">trimws</a></span><span class="op">(</span><span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Correct misspellings</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Amphidnium"</span>, <span class="st">"Amphidinium"</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Enisiculifera"</span>, <span class="st">"Ensiculifera"</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Standardize ambiguous class names by renaming them to their closest taxonomic relatives</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Dinoflagellate"</span>, <span class="st">"Dinophyceae"</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Leptocylindrus danicus minimus"</span>, <span class="st">"Leptocylindrus"</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Heterocapsa/Azadinium"</span>, <span class="st">"Peridiniphycidae"</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span><span class="va">taxa_names_clean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"Cylindrotheca/Nitzschia longissima"</span>, <span class="st">"Bacillariaceae"</span>, <span class="va">taxa_names_clean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Retrieve worms records</span></span>
<span><span class="va">worms_records</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ifcb_match_taxa_names.html">ifcb_match_taxa_names</a></span><span class="op">(</span><span class="va">taxa_names_clean</span>,</span>
<span>                                       marine_only <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                       fuzzy <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                       verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create data frame with taxa information and class names</span></span>
<span><span class="va">class_names</span> <span class="op">&lt;-</span> <span class="va">worms_records</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class_name <span class="op">=</span> <span class="va">taxa_names</span>, class_clean <span class="op">=</span> <span class="va">taxa_names_clean</span><span class="op">)</span></span></code></pre></div>
<p>The <strong>scientificName</strong> and
<strong>verbatimIdentification</strong> fields are populated using the
cleaned taxonomic names and the original class names, respectively.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_occurrences</span> <span class="op">&lt;-</span> <span class="va">data_occurrences</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>class_name <span class="op">=</span> <span class="va">class</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">class_names</span>, by <span class="op">=</span> <span class="st">"class_name"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>scientificName <span class="op">=</span> <span class="va">name</span>,</span>
<span>         scientificNameAuthorship <span class="op">=</span> <span class="va">authority</span>,</span>
<span>         verbatimIdentification <span class="op">=</span> <span class="va">class_name</span>,</span>
<span>         scientificNameID <span class="op">=</span> <span class="va">lsid</span>,</span>
<span>         taxonRank <span class="op">=</span> <span class="va">rank</span>,</span>
<span>         occurrenceStatus <span class="op">=</span> <span class="st">"present"</span><span class="op">)</span></span></code></pre></div>
<p>The final Occurrence table includes all relevant fields for DwC-A
formatting.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select relevant fields</span></span>
<span><span class="va">occurrence_df</span> <span class="op">&lt;-</span> <span class="va">data_occurrences</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">occurrenceID</span>, <span class="va">eventID</span>, <span class="va">eventDate</span>, <span class="va">occurrenceStatus</span>, <span class="va">collectionCode</span>, </span>
<span>         <span class="va">type</span>, <span class="va">basisOfRecord</span>, <span class="va">identificationVerificationStatus</span>, </span>
<span>         <span class="va">identificationReferences</span>, <span class="va">identifiedBy</span>, <span class="va">associatedMedia</span>, </span>
<span>         <span class="va">scientificName</span>, <span class="va">scientificNameAuthorship</span>, <span class="va">scientificNameID</span>, </span>
<span>         <span class="va">taxonRank</span>, <span class="va">kingdom</span>,  <span class="va">phylum</span>, <span class="va">class</span>, <span class="va">order</span>, <span class="va">family</span>, <span class="va">genus</span>, </span>
<span>         <span class="va">verbatimIdentification</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the final table as tibble</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">occurrence_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 101 × 22</span></span></span>
<span><span class="co">##    occurrenceID         eventID eventDate  occurrenceStatus collectionCode type </span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 9c18daec-8dab-4b6c-… 6196dc… 2022-05-22 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 8e6bbf89-d935-4266-… 6196dc… 2022-05-22 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 80b556d2-3fdd-467e-… 6196dc… 2022-05-22 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> 89f738c3-60e4-4ecd-… 6196dc… 2022-05-22 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> be42945b-c224-40ed-… d467c8… 2022-05-22 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> 5347a4aa-e152-4ad5-… 2847e1… 2022-07-12 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> ed4fd2e0-67f1-4fdd-… 2847e1… 2022-07-12 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 471b5b40-cdd0-48db-… 2847e1… 2022-07-12 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 18af7152-2ba9-4e7a-… c7aabe… 2022-07-12 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 7ada59e0-b905-483f-… c7aabe… 2022-07-12 present          iRfcb          Stil…</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 91 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 16 more variables: basisOfRecord &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   identificationVerificationStatus &lt;chr&gt;, identificationReferences &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   identifiedBy &lt;chr&gt;, associatedMedia &lt;chr&gt;, scientificName &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   scientificNameAuthorship &lt;chr&gt;, scientificNameID &lt;chr&gt;, taxonRank &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   kingdom &lt;chr&gt;, phylum &lt;chr&gt;, class &lt;chr&gt;, order &lt;chr&gt;, family &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   genus &lt;chr&gt;, verbatimIdentification &lt;chr&gt;</span></span></span></code></pre>
<p>The occurrence data is initialized for GBIF submission using the
<code>initializeGBIFOccurrence</code> function, which maps fields
automatically based on the specified column.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GBIF_Occurrence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://livingnorway.github.io/LivingNorwayR/reference/initializeGBIFOccurrence.html" class="external-link">initializeGBIFOccurrence</a></span><span class="op">(</span><span class="va">occurrence_df</span>, </span>
<span>                                            idColumnInfo <span class="op">=</span> <span class="st">"occurrenceID"</span>, </span>
<span>                                            nameAutoMap <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="mof-extension">MoF Extension<a class="anchor" aria-label="anchor" href="#mof-extension"></a>
</h2>
<p>The MoF table allows us to capture any additional measurements and
facts associated with occurrences, such as biological or environmental
measurements associated with the events (samples) or the occurrences.
For IFCB data, we can include information such as counts, abundance,
biovolume concentration, and carbon content. These measurements provide
essential context for understanding the ecological significance of the
observations.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a dataset for occurrences (no modifications made here)</span></span>
<span><span class="va">data_occurrence_mof</span> <span class="op">&lt;-</span> <span class="va">data_occurrences</span></span>
<span></span>
<span><span class="co"># Add placeholder for occurrence IDs in the event dataset</span></span>
<span><span class="va">data_event_mof</span> <span class="op">&lt;-</span> <span class="va">data_event</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>occurrenceID <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add placeholders for occurrence IDs and specify instrument type in the parent event dataset</span></span>
<span><span class="va">data_parent_mof</span> <span class="op">&lt;-</span> <span class="va">data_parent_event</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>occurrenceID <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>         instrument <span class="op">=</span> <span class="st">"IFCB"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we extract the necessary columns from the dataset that will be
used in the MoF table. This includes the measurement ID, associated
event and occurrence IDs, and key IFCB-derived measurements such as
counts, abundance, biovolume, and carbon concentration.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert biovolume units and select the relevant columns for occurrence MoF</span></span>
<span><span class="va">data_occurrence_mof</span> <span class="op">&lt;-</span> <span class="va">data_occurrence_mof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>biovolume_um3_per_liter <span class="op">=</span> <span class="va">biovolume_mm3_per_liter</span> <span class="op">*</span> <span class="fl">10</span><span class="op">^</span><span class="fl">9</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">eventID</span>, <span class="va">parentEventID</span>, <span class="va">occurrenceID</span>, <span class="va">counts</span>, </span>
<span>         <span class="va">counts_per_liter</span>, <span class="va">biovolume_um3_per_liter</span>, <span class="va">carbon_ug_per_liter</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select the relevant columns for parentEvent MoF</span></span>
<span><span class="va">data_parent_mof</span> <span class="op">&lt;-</span> <span class="va">data_parent_mof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">eventID</span>, <span class="va">parentEventID</span>, <span class="va">occurrenceID</span>, <span class="va">instrument</span>, <span class="va">ifcb_number</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Select the relevant columns for event MoF</span></span>
<span><span class="va">data_event_mof</span> <span class="op">&lt;-</span> <span class="va">data_event_mof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">eventID</span>, <span class="va">parentEventID</span>, <span class="va">occurrenceID</span>, <span class="va">ml_analyzed</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The table needs to be transformed into a “long format,” where all
measurements are placed into a single column called
<strong>measurementType</strong>, with their corresponding values in
<strong>measurementValue</strong>. This is done using the
<code>pivot_longer</code> function.</p>
<p>We also standardize the measurement types to align with controlled
vocabularies (e.g., <em>Abundance</em>, <em>Biovolume
concentration</em>) for better compatibility with global biodiversity
standards.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pivot and standardize occurrence measurements</span></span>
<span><span class="va">data_occurrence_mof</span> <span class="op">&lt;-</span> <span class="va">data_occurrence_mof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">counts_per_liter</span>, <span class="va">biovolume_um3_per_liter</span>, <span class="va">carbon_ug_per_liter</span><span class="op">)</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">"measurementType"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"measurementValue"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="va">measurementValue</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"counts_per_liter"</span>, <span class="st">"Abundance"</span>, <span class="va">measurementType</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"biovolume_um3_per_liter"</span>, <span class="st">"Biovolume concentration"</span>, <span class="va">measurementType</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"carbon_ug_per_liter"</span>, <span class="st">"Carbon content"</span>, <span class="va">measurementType</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"counts"</span>, <span class="st">"Count"</span>, <span class="va">measurementType</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementValue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">measurementValue</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pivot and standardize event measurements</span></span>
<span><span class="va">data_event_mof</span> <span class="op">&lt;-</span> <span class="va">data_event_mof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ml_analyzed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">ml_analyzed</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ml_analyzed</span><span class="op">)</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">"measurementType"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"measurementValue"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"ml_analyzed"</span>, <span class="st">"Sample volume"</span>, <span class="va">measurementType</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Pivot and standardize parent measurements</span></span>
<span><span class="va">data_parent_mof</span> <span class="op">&lt;-</span> <span class="va">data_parent_mof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">instrument</span>, <span class="va">ifcb_number</span><span class="op">)</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">"measurementType"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"measurementValue"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"instrument"</span>, <span class="st">"Imaging instrument name"</span>, <span class="va">measurementType</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"ifcb_number"</span>, <span class="st">"Instrument identification number"</span>, <span class="va">measurementType</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine all standardized measurements into a single dataset and add unique measurementIDs for each measurment</span></span>
<span><span class="va">data_mof</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">data_parent_mof</span>, <span class="va">data_event_mof</span>, <span class="va">data_occurrence_mof</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>measurementID <span class="op">=</span> <span class="fu">uuid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/uuid/man/UUIDgenerate.html" class="external-link">UUIDgenerate</a></span><span class="op">(</span>use.time <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To ensure data interoperability, we match each measurement type with
its corresponding controlled vocabulary terms from the <a href="https://vocab.nerc.ac.uk/" class="external-link">NERC Vocabulary Server</a>. This
includes assigning <strong>measurementTypeID</strong>,
<strong>measurementUnit</strong>, and <strong>measurementUnitID</strong>
for each <strong>measurementType</strong>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a lookup table for NERC vocabularies</span></span>
<span><span class="va">nerc_vocab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  measurementValueID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">6</span><span class="op">)</span>, </span>
<span>                         <span class="st">"http://vocab.nerc.ac.uk/collection/L22/current/TOOL1588/"</span><span class="op">)</span>,</span>
<span>  measurementType <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Count"</span>, </span>
<span>                      <span class="st">"Abundance"</span>, </span>
<span>                      <span class="st">"Biovolume concentration"</span>, </span>
<span>                      <span class="st">"Carbon content"</span>,</span>
<span>                      <span class="st">"Sample volume"</span>,</span>
<span>                      <span class="st">"Instrument identification number"</span>,</span>
<span>                      <span class="st">"Imaging instrument name"</span><span class="op">)</span>,</span>
<span>  measurementTypeID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/OCOUNT01/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SDBIOL01"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/CVOLUKNB/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/MDMAP010/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/VOLXXXXX/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/SERNUMZZ/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P01/current/NMSPINST/"</span><span class="op">)</span>,</span>
<span>  measurementUnit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Dimensionless"</span>, </span>
<span>                      <span class="st">"Individual per litre"</span>, </span>
<span>                      <span class="st">"Cubic micrometres per litre"</span>, </span>
<span>                      <span class="st">"Micrograms per litre"</span>,</span>
<span>                      <span class="st">"Millilitres"</span>,</span>
<span>                      <span class="st">"Not applicable"</span>,</span>
<span>                      <span class="st">"Not applicable"</span><span class="op">)</span>,</span>
<span>  measurementUnitID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UUUU/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UCPL/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/CUPL/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/UGPL/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/VVML/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/XXXX/"</span>,</span>
<span>                        <span class="st">"http://vocab.nerc.ac.uk/collection/P06/current/XXXX/"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Merge the data with NERC vocabularies and relocate columns</span></span>
<span><span class="va">mof_df</span> <span class="op">&lt;-</span> <span class="va">data_mof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">nerc_vocab</span>, by <span class="op">=</span> <span class="st">"measurementType"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">measurementTypeID</span>, .after <span class="op">=</span> <span class="va">measurementType</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">measurementID</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the final table as tibble</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">mof_df</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 415 × 10</span></span></span>
<span><span class="co">##    measurementID              eventID parentEventID occurrenceID measurementType</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> 9c7fe094-53b8-4783-84c5-c… 282da5… <span style="color: #BB0000;">NA</span>            <span style="color: #BB0000;">NA</span>           Imaging instru…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> 7a244139-4eaf-4a6b-804e-b… 282da5… <span style="color: #BB0000;">NA</span>            <span style="color: #BB0000;">NA</span>           Instrument ide…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> 50e64749-4067-43ba-bbc4-c… 6196dc… 282da5ef-a2d… <span style="color: #BB0000;">NA</span>           Sample volume  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> de76fdcc-f14e-4df7-a265-f… d467c8… 282da5ef-a2d… <span style="color: #BB0000;">NA</span>           Sample volume  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> fe78ea1a-2999-4632-a4b5-3… 2847e1… 282da5ef-a2d… <span style="color: #BB0000;">NA</span>           Sample volume  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> fbec1ca8-ef75-4f66-ae38-0… c7aabe… 282da5ef-a2d… <span style="color: #BB0000;">NA</span>           Sample volume  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> aea7fe4e-0eff-400d-9279-6… 412324… 282da5ef-a2d… <span style="color: #BB0000;">NA</span>           Sample volume  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> 9364e3ba-9dc9-4760-8977-d… 86ec73… 282da5ef-a2d… <span style="color: #BB0000;">NA</span>           Sample volume  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> 9d447b32-4987-4778-9ce7-4… 09e32e… 282da5ef-a2d… <span style="color: #BB0000;">NA</span>           Sample volume  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> 02e9f9a1-926d-4b54-93ee-d… 8ddaa3… 282da5ef-a2d… <span style="color: #BB0000;">NA</span>           Sample volume  </span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 405 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 5 more variables: measurementTypeID &lt;chr&gt;, measurementValue &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   measurementValueID &lt;chr&gt;, measurementUnit &lt;chr&gt;, measurementUnitID &lt;chr&gt;</span></span></span></code></pre>
<p>Finally, the extended measurement or fact table is prepared for GBIF
by initializing the dataset in a compatible format using the
<code>initializeGBIFMeasurementOrFact</code> function. The measurement
IDs are used as unique identifiers, and columns are mapped
automatically.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GBIF_MoF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://livingnorway.github.io/LivingNorwayR/reference/initializeGBIFMeasurementOrFact.html" class="external-link">initializeGBIFMeasurementOrFact</a></span><span class="op">(</span><span class="va">mof_df</span>, </span>
<span>                                            idColumnInfo <span class="op">=</span> <span class="st">"measurementID"</span>, </span>
<span>                                            nameAutoMap <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="metadata">Metadata<a class="anchor" aria-label="anchor" href="#metadata"></a>
</h2>
<p>Metadata is an integral part of biodiversity datasets, as it ensures
data discoverability, transparency, and reusability. The Ecological
Metadata Language (EML) is a widely accepted XML-based standard used to
describe datasets, including those formatted as DwC-A. For datasets
intended for submission to platforms like GBIF, EML provides a robust
structure to communicate essential information about the dataset’s
scope, methods, and contributors.</p>
<div class="section level3">
<h3 id="creating-metadata-for-ifcb-data">Creating Metadata for IFCB Data<a class="anchor" aria-label="anchor" href="#creating-metadata-for-ifcb-data"></a>
</h3>
<p>To create metadata for the IFCB dataset in a standardized format, we
use the <code>initializeDwCMetadata</code> function. This function
generates a template that follows DwC guidelines, which can then be
customized with specific details about the dataset.</p>
<p>Here, we create the metadata starting with a Markdown file (<a href="../articles/metadata-template.html"><code>metadata-template.rmd</code></a>),
which will be rendered into an EML-compliant XML file for GBIF
submission:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialize DwC metadata using a R Markdown template</span></span>
<span><span class="va">GBIF_Metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://livingnorway.github.io/LivingNorwayR/reference/initializeDwCMetadata.html" class="external-link">initializeDwCMetadata</a></span><span class="op">(</span><span class="st">"metadata-template.rmd"</span>, </span>
<span>                                       fileType <span class="op">=</span> <span class="st">"rmarkdown"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="dwc-a-creation">DwC-A Creation<a class="anchor" aria-label="anchor" href="#dwc-a-creation"></a>
</h2>
<p>In this step, the finalized tables (<code>GBIF_Event</code>,
<code>GBIF_Occurrence</code>, and <code>GBIF_MoF</code>) and the
metadata (<code>GBIF_Metadata</code>) are bundled together into a DwC-A
<code>.zip</code> file that is ready for submission to platforms like
GBIF using an Integrated Publishing Toolkit (IPT), e.g. the <a href="https://ipt.vliz.be/eurobis/" class="external-link">EurOBIS IPT</a>.</p>
<p>Here is the code for initializing and exporting the DwC-A:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialize the DwC-A</span></span>
<span><span class="va">dwca_archive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://livingnorway.github.io/LivingNorwayR/reference/initializeDwCArchive.html" class="external-link">initializeDwCArchive</a></span><span class="op">(</span><span class="va">GBIF_Event</span>, </span>
<span>                                     <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">GBIF_Occurrence</span>, <span class="va">GBIF_MoF</span><span class="op">)</span>, </span>
<span>                                     <span class="va">GBIF_Metadata</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Export the archive as a zip file</span></span>
<span><span class="va">dwca_archive</span><span class="op">$</span><span class="fu">exportAsDwCArchive</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"iRfcb-DwC-A.zip"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This concludes this tutorial for the <code>iRfcb</code> package. For
more detailed information, refer to the package documentation or the
other <a href="../articles/index.html">tutorials</a>, and the <a href="https://livingnorway.github.io/LivingNorwayR/" class="external-link"><code>LivingNorwayR</code></a>
documentation. See how more complex data pipelines can be constructed
using <code>iRfcb</code> in the following <a href="https://github.com/nodc-sweden/ifcb-data-pipeline" class="external-link">Example
Project</a>. Happy analyzing!</p>
</div>
<div class="section level2">
<h2 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h2>
<pre><code><span><span class="co">## To cite package 'iRfcb' in publications use:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   Anders Torstensson (2025). I 'R' FlowCytobot (iRfcb): Tools for</span></span>
<span><span class="co">##   Analyzing and Processing Data from the IFCB. R package version 0.4.1.</span></span>
<span><span class="co">##   https://doi.org/10.5281/zenodo.12533225</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## A BibTeX entry for LaTeX users is</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   @Manual{,</span></span>
<span><span class="co">##     title = {I 'R' FlowCytobot (iRfcb): Tools for Analyzing and Processing Data from the IFCB},</span></span>
<span><span class="co">##     author = {Anders Torstensson},</span></span>
<span><span class="co">##     year = {2025},</span></span>
<span><span class="co">##     note = {R package version 0.4.1},</span></span>
<span><span class="co">##     url = {https://doi.org/10.5281/zenodo.12533225},</span></span>
<span><span class="co">##   }</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Martin-Cabrera, P., Perez Perez, R., Irisson, J.-O., Lombard, F.,
Möller, K.O., Rühl, S., Creach, V., Lindh, M., Stemmann, L., Schepers,
L. (2022). Best practices and recommendations for plankton imaging data
management: ensuring effective data flow towards international data
infrastructures. Version 1. Flanders Marine Institute: Ostend. 31 pp. <a href="https://dx.doi.org/10.25607/OBP-1742" class="external-link uri">https://dx.doi.org/10.25607/OBP-1742</a>.</li>
<li>Sosik, H. M. and Olson, R. J. (2007) Automated taxonomic
classification of phytoplankton sampled with imaging-in-flow cytometry.
Limnol. Oceanogr: Methods 5, 204–216.</li>
<li>Torstensson, A., Skjevik, A-T., Mohlin, M., Karlberg, M. and
Karlson, B. (2024). SMHI IFCB Plankton Image Reference Library.
SciLifeLab. Dataset. <a href="https://doi.org/10.17044/scilifelab.25883455.v3" class="external-link uri">https://doi.org/10.17044/scilifelab.25883455.v3</a>
</li>
<li>Urbanek, Simon, and Theodore Ts’o. 2021. Uuid: Tools for Generating
and Handling of UUIDs. <a href="https://CRAN.R-project.org/package=uuid" class="external-link uri">https://CRAN.R-project.org/package=uuid</a>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Anders Torstensson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
